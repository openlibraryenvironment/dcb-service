# ORS Appliance Supplying Service Spec (Abstract)

This document defines a protocol-agnostic contract between ORS-Appliance (mediator) and a supplying system (Folio, Sierra, Alma, Polaris) for resource sharing. It is intended to guide plugin design without constraining implementation details.

The contract must support:
- Physical copy, returnable loans
- Physical copy, non-returnable (e.g., photocopy/scan) fulfillment
- Electronic loans, both open-access and DRM-protected

The contract is expressed as a set of capabilities, message types, state transitions, and data requirements. Transport (HTTP, ISO18626, NCIP, SIP2, proprietary APIs) is out of scope.

## Roles

- ORS-Appliance: mediator that coordinates requests across multiple supply services.
- Supplying Service: system that can fulfill a request (Folio, Sierra, Alma, Polaris, etc.).
- Requesting System: the borrowing side (outside the scope of this spec).

## Core Concepts

- Request: a unit of work initiated by ORS-Appliance for a patron request.
- Supply Service: a single fulfillment target with its own policies, inventory, and workflows.
- Fulfillment Type:
  - PHYSICAL_RETURNABLE
  - PHYSICAL_NON_RETURNABLE
  - ELECTRONIC_OPEN
  - ELECTRONIC_DRM

## Capability Declaration

Each supplying service exposes a capability profile to ORS-Appliance.

Minimum fields:
- serviceId
- supportedFulfillmentTypes
- supportsAvailabilityCheck (boolean)
- supportsItemHold (boolean)
- supportsLocationHold (boolean)
- supportsPatronVerification (boolean)
- supportsRenewal (boolean)
- supportsRecall (boolean)
- supportsCancel (boolean)
- supportsStatusPolling (boolean)
- supportsEventPush (boolean)
- supportsElectronicDelivery (boolean)
- supportsDigitalHold (boolean)
- supportsFeesAndBilling (boolean)
- timeouts (availability, hold, delivery)

## Shared Data Model

All messages should carry the following common fields:
- requestId (generated by ORS-Appliance)
- supplyServiceId
- patronId (opaque to supply service; may be mapped)
- fulfillmentType
- bibliographic (title, author, identifiers)
- itemConstraints (edition, format, language, volume, etc.)
- deliveryPreferences (pickup location, delivery method)
- requestDates (needBy, latestPickup, requiredBy)
- requestSource (borrowing context)

Optional fields:
- patronContact (if supported)
- patronEligibilityToken (if supported)
- licensingContext (for electronic)
- shippingAddress (for physical returnable)
- returnShippingLabel (if supported)

## Message Types

The contract defines message types that can be mapped to any transport.

### 1) Availability Query

Purpose: Determine whether the supply service can fulfill the request.

Request:
- requestId
- fulfillmentType
- bibliographic
- itemConstraints

Response:
- available (boolean)
- availabilityDetail (copyCount, location, earliestAvailability)
- fulfillmentTypeAllowed (list)
- policyConstraints (loanPeriod, renewalsAllowed, nonReturnableAllowed)

### 2) Patron Verification (optional)

Purpose: Confirm patron eligibility if required by the supply service.

Request:
- patronId
- patronEligibilityToken (optional)

Response:
- eligible (boolean)
- reason (if ineligible)

### 3) Place Hold / Request

Purpose: Create a fulfillment request in the supply system.

Request:
- requestId
- patronId (or mapped patron)
- fulfillmentType
- bibliographic
- itemConstraints
- deliveryPreferences
- requestDates

Response:
- supplyRequestId
- status (see Status Model)
- expectedReadyDate
- pickupLocation (if applicable)

### 4) Status Inquiry / Update

Purpose: Get current status or push status updates.

Request:
- requestId or supplyRequestId

Response:
- status
- statusDetail
- dueDate (for returnable)
- deliveryUrl (for electronic)
- trackingInfo (for physical shipment)

### 5) Renewal

Purpose: Extend a returnable loan if allowed.

Request:
- supplyRequestId
- newDueDate (optional)

Response:
- approved (boolean)
- dueDate
- reason (if rejected)

### 6) Cancel

Purpose: Cancel a request prior to completion.

Request:
- supplyRequestId

Response:
- cancelled (boolean)
- reason (if rejected)

### 7) Item Shipped / Delivered (event)

Purpose: Notify ORS-Appliance of fulfillment progress.

Event payload:
- supplyRequestId
- status
- trackingInfo (physical)
- deliveryUrl (electronic)
- deliveryToken (DRM)

### 8) Return / Close (event)

Purpose: Notify ORS-Appliance of return or completion.

Event payload:
- supplyRequestId
- status
- returnDate
- feesOrFines (optional)

## Status Model

Supply services map their internal states to these abstract statuses:

- REQUEST_ACCEPTED
- REQUEST_REJECTED
- HOLD_PLACED
- HOLD_READY
- ITEM_IN_TRANSIT
- ITEM_SHIPPED
- ITEM_RECEIVED_BY_BORROWER
- DELIVERY_READY
- ACCESS_GRANTED
- ACCESS_EXPIRED
- LOANED
- DUE_DATE_SET
- RENEWED
- RETURNED
- COMPLETED
- CANCELLED
- ERROR

Notes:
- Physical returnable should include LOANED, DUE_DATE_SET, RETURNED.
- Physical non-returnable should include COMPLETED after delivery.
- Electronic open should include DELIVERY_READY and COMPLETED.
- Electronic DRM should include DELIVERY_READY, ACCESS_GRANTED, ACCESS_EXPIRED, COMPLETED.

## Fulfillment Flows

### A) Physical Returnable

1. Availability Query (optional)
2. Patron Verification (optional)
3. Place Hold / Request
4. HOLD_PLACED or REQUEST_ACCEPTED
5. ITEM_SHIPPED or ITEM_IN_TRANSIT
6. LOANED + DUE_DATE_SET
7. RENEWED (optional)
8. RETURNED
9. COMPLETED

### B) Physical Non-Returnable

1. Availability Query (optional)
2. Place Hold / Request
3. REQUEST_ACCEPTED
4. ITEM_SHIPPED or DELIVERY_READY
5. COMPLETED

### C) Electronic Open

1. Availability Query (optional)
2. Place Request
3. REQUEST_ACCEPTED
4. DELIVERY_READY with deliveryUrl
5. COMPLETED

### D) Electronic DRM

1. Availability Query (optional)
2. Place Request
3. REQUEST_ACCEPTED
4. DELIVERY_READY with deliveryToken
5. ACCESS_GRANTED
6. ACCESS_EXPIRED
7. COMPLETED

## Error Handling

Errors should be returned with:
- errorCode (stable string)
- message (human-readable)
- retryable (boolean)
- correlationId

Common error categories:
- PATRON_INELIGIBLE
- ITEM_UNAVAILABLE
- POLICY_BLOCK
- SYSTEM_DOWN
- INVALID_REQUEST

## Idempotency and Correlation

- All write actions (Place Hold, Cancel, Renewal) must be idempotent when given the same requestId.
- supplyRequestId is the supplying system reference and should be returned on all updates.
- ORS-Appliance should include a correlationId on all requests for audit tracing.

## Security and Privacy

- Patron identifiers may be opaque and mapped by the plugin.
- Minimize personal data unless required by the supplying system.
- Delivery URLs or tokens must be short-lived or scoped as required by DRM policies.

## Extensibility

- Supply services can include vendor-specific fields in an `extensions` object without breaking the core contract.
- Unknown status values must be treated as `ERROR` or mapped to the closest abstract status.

## Conformance

A plugin is conformant if it:
- Declares capabilities accurately
- Implements required message types for its supported fulfillment types
- Maps internal states to the abstract status model
- Returns consistent identifiers and timestamps

## Appendix A: ISO18626 Message Mapping (Abstract)

This appendix shows a conceptual mapping between the abstract contract and ISO18626 message types. It does not prescribe transport bindings or XML/JSON representations.

### 1) Availability Query

ISO18626 does not define a dedicated availability query. Common patterns include:
- Use `Request` with a policy that allows rejection without side effects
- Use local system bibliographic/holdings APIs outside ISO18626

Recommended mapping when using ISO18626:
- Abstract "Availability Query" maps to a non-committal `Request` or to a local pre-check outside ISO18626.

### 2) Patron Verification

ISO18626 does not define a patron verification message. Mapping options:
- Use local patron APIs outside ISO18626
- Use `Request` with patron data and allow `RequestResponse` to reject for eligibility reasons

### 3) Place Hold / Request

Mapping:
- Abstract "Place Hold / Request" maps to ISO18626 `Request`
- Abstract response maps to ISO18626 `RequestResponse`

Key fields:
- requestId -> `requestId`
- bibliographic -> `bibliographicInfo`
- patronId -> `requester/patronId` (or system-specific extension)
- fulfillmentType -> `serviceInfo/serviceType` or extension
- deliveryPreferences -> `serviceInfo` and `requester` address/pickup details

### 4) Status Inquiry / Update

Mapping options:
- `Request` with `requestType=Status` if the profile supports it
- `RequestResponse` for synchronous status
- `SupplyingAgencyMessage` for asynchronous status updates

Recommended:
- Use `SupplyingAgencyMessage` to push status changes
- Use `Request`/`RequestResponse` for polling where push is not available

### 5) Renewal

ISO18626 does not define a renewal message. Mapping options:
- `Request` with a renewal service type in `serviceInfo` (profile extension)
- Use local circulation APIs outside ISO18626

### 6) Cancel

Mapping:
- Abstract "Cancel" maps to ISO18626 `Request` with `requestType=Cancel` if profile supports it
- Response maps to `RequestResponse` or `SupplyingAgencyMessage`

### 7) Item Shipped / Delivered (event)

Mapping:
- Abstract "Item Shipped / Delivered" maps to ISO18626 `SupplyingAgencyMessage`

Key fields:
- supplyRequestId -> `requestId` or `supplyingAgencyRequestId`
- status -> `requestStatus` with profile-specific codes
- trackingInfo -> `shippingInfo` (if available) or extension
- deliveryUrl / deliveryToken -> extension

### 8) Return / Close (event)

Mapping:
- Abstract "Return / Close" maps to ISO18626 `SupplyingAgencyMessage`

Key fields:
- returnDate -> `requestStatusDate`
- feesOrFines -> extension (if not modeled in the profile)

### Status Mapping Guidance

ISO18626 defines status codes and reason codes but allows profile extensions. Recommended mapping:
- REQUEST_ACCEPTED -> `RequestResponse` accepted
- REQUEST_REJECTED -> `RequestResponse` rejected with reason
- HOLD_PLACED / HOLD_READY -> `SupplyingAgencyMessage` with hold-related status
- ITEM_SHIPPED / ITEM_IN_TRANSIT -> `SupplyingAgencyMessage` with shipped/in-transit
- LOANED / DUE_DATE_SET -> `SupplyingAgencyMessage` with loaned + due date in extension
- RETURNED / COMPLETED -> `SupplyingAgencyMessage` with completed/returned status
- DELIVERY_READY / ACCESS_GRANTED / ACCESS_EXPIRED -> `SupplyingAgencyMessage` with electronic delivery extensions

### Notes on Profiles and Extensions

- ISO18626 profiles vary across consortia; use profile-specific enums where available.
- When a concept is not supported in the base profile, carry it in an `extensions` object while preserving the abstract status mapping.
